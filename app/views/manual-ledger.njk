{% extends '_layout.njk' %}

{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}

{% from "macros/search-input.njk" import searchInput %}

{% block content %}
  {{ govukBackLink({
    text: "Back",
    href: "/",
    attributes: {
      id: "back"
    }
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-l">Manual Ledger Assignment</h1>

      {% if ledgerData.length %}
        <div class="govuk-!-padding-bottom-3">
          <div class="govuk-!-width-one-third">
            <form action="/manual-ledger" method="POST">
              <input type="hidden" name="crumb" value="{{crumb}}"/>
              {{ searchInput(model) }}
            </form>
          </div>

          <p class="govuk-body">
            <a href="/manual-ledger" class="govuk-link govuk-link--no-visited-state">View all existing manual ledger assignment datasets</a>
          </p>

          <div class="govuk-!-text-align-right govuk-!-margin-bottom-6">
            <form action="/manual-ledger" method="get">
              {{ govukSelect({
                id: "perPage",
                name: "perPage",
                label: {
                  text: "Number of records per page"
                },
                attributes: {
                  onchange: "this.form.submit()"
                },
                items: [
                  {
                    value: 100,
                    text: "100",
                    selected: perPage == 100
                  },
                  {
                    value: 500,
                    text: "500",
                    selected: perPage == 500
                  },
                  {
                    value: 1000,
                    text: "1000",
                    selected: perPage == 1000
                  }
                ]
              }) }}
            </form>
          </div>

          {% set tableRows = [] %}
          {% for data in ledgerData %}
            {% set actionHtml %}
              {% if not data.manualLedgerChecked %}
                <a href="/manual-ledger-check?paymentrequestid={{data.paymentRequestId}}" class="govuk-link" aria-label="Review invoice {{ data.invoiceNumber }} for FRN {{ data.frn }}">Review</a>
              {% endif %}
            {% endset %}

            {% set tableRows = (tableRows.push([
              { text: data.schemeName, classes: "govuk-body-s" },
              { text: data.marketingYear, classes: "govuk-body-s" },
              { text: data.frn, classes: "govuk-body-s" },
              { text: data.agreementNumber, classes: "govuk-body-s" },
              { text: data.invoiceNumber, classes: "govuk-body-s" },
              { text: data.paymentRequestNumber, format: "numeric", classes: "govuk-body-s" },
              { text: data.valueText, format: "numeric", classes: "govuk-body-s noWrap" },
              { text: data.receivedFormatted, classes: "govuk-body-s" },
              { html: actionHtml, classes: "govuk-body-s" }
            ]), tableRows) %}
          {% endfor %}

          {{ govukTable({
            caption: "Manual Ledger Assignments",
            captionClasses: "govuk-table__caption--s",
            head: [
              { text: "Scheme", classes: "govuk-body-s" },
              { text: "Scheme Year", classes: "govuk-body-s" },
              { text: "FRN", classes: "govuk-body-s" },
              { text: "Agreement number", classes: "govuk-body-s" },
              { text: "Invoice", classes: "govuk-body-s" },
              { text: "Request", format: "numeric", classes: "govuk-body-s" },
              { text: "Total amount", format: "numeric", classes: "govuk-body-s" },
              { text: "Received", classes: "govuk-body-s" },
              { text: "Actions", classes: "govuk-body-s" }
            ],
            rows: tableRows
          }) }}

          {% set paginationItems = [] %}
          {% if page > 1 %}
            {% set paginationPrevious = {
              href: "?page=" + (page - 1) + "&perPage=" + perPage,
              labelText: "Previous page"
            } %}
          {% endif %}

          {% if ledgerData.length >= perPage %}
            {% set paginationNext = {
              href: "?page=" + (page + 1) + "&perPage=" + perPage,
              labelText: "Next page"
            } %}
          {% endif %}

          {{ govukPagination({
            previous: paginationPrevious,
            next: paginationNext,
            items: [
              {
                number: page,
                current: true
              }
            ]
          }) }}
        </div>
      {% else %}
        {{ govukInsetText({
          text: "No payment requests awaiting for manual ledger assignment"
        }) }}
      {% endif %}
    </div>
  </div>
{% endblock %}